
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/shop.css">
  <link rel="stylesheet" href="../assets/fonts/fontawesome/css/all.css">

<div class="shop-container">
  <div class="shop-titlebar">
    <h1>Enjoy Shopping our Games</h1>
  </div>
  <div class="shop-filter">
    <form method="GET">
      <div class="shop-filter-top">
        <h1>Filter</h1>
        <button type="submit" name="button">Apply</button>
      </div>
      <div class="shop-filter-content">
                <div class="shop-filter-body">
                   <h6>Price Sort</h6>
                   <hr>
                   <?php
                        //Liste aus Checkboxes für die Sortier mölichkeiten
                       $con = mysqli_connect("localhost","root","","ludomo");

                       $price_query = "SELECT * FROM price_sort";
                       $price_query_run  = mysqli_query($con, $price_query);

                       if(mysqli_num_rows($price_query_run) > 0)
                       {
                           foreach($price_query_run as $pricelist)
                           {
                               $checked = [];
                               if(isset($_GET['price']))
                               {
                                   $checked = $_GET['price'];
                               }
                               ?>
                                   <div>
                                       <input type="checkbox" name="price[]" value="<?= $pricelist['id']; ?>"
                                           <?php
                                           // gewählte Filter Optionen speichern
                                           if(in_array($pricelist['id'], $checked)){
                                             echo "checked";
                                         } ?>
                                        />
                                        <?= $pricelist['price']; ?>
                                   </div>
                               <?php
                           }
                       }
                       else
                       {
                           echo "No prices Found";
                       }
                   ?>
               </div>

               <div class="shop-filter-body">
                  <h6>Game Mode</h6>
                  <hr>
                  <?php
                      //Die Filter Liste anzeigen und Mode möglichkeiten zum Filtern Darstellen
                      $con = mysqli_connect("localhost","root","","ludomo");

                      $mode_query = "SELECT * FROM mode_list";
                      $mode_query_run  = mysqli_query($con, $mode_query);

                      if(mysqli_num_rows($mode_query_run) > 0)
                      {
                          foreach($mode_query_run as $modelist)
                          {
                              $checked = [];
                              if(isset($_GET['mode']))
                              {
                                  $checked = $_GET['mode'];
                              }
                              ?>
                                  <div>
                                      <input type="checkbox" name="mode[]" value="<?= $modelist['id']; ?>"
                                          <?php if(in_array($modelist['id'], $checked)){ echo "checked"; } ?>
                                       />
                                       <?= $modelist['mode']; ?>
                                  </div>
                              <?php
                          }
                      }
                      else
                      {
                          echo "No mode Found";
                      }
                  ?>
              </div>

              <div class="shop-filter-body">
                 <h6>Platform</h6>
                 <hr>
                 <?php
                    //Die Filter Liste anzeigen und Platform möglichkeiten zum Filtern Darstellen
                     $con = mysqli_connect("localhost","root","","ludomo");

                     $platform_query = "SELECT * FROM platform";
                     $platform_query_run  = mysqli_query($con, $platform_query);

                     if(mysqli_num_rows($platform_query_run) > 0)
                     {
                         foreach($platform_query_run as $platformlist)
                         {
                             $checked = [];
                             if(isset($_GET['platform']))
                             {
                                 $checked = $_GET['platform'];
                             }
                             ?>
                                 <div>
                                     <input type="checkbox" name="platform[]" value="<?= $platformlist['id']; ?>"
                                         <?php if(in_array($platformlist['id'], $checked)){ echo "checked"; } ?>
                                      />
                                      <?= $platformlist['platform']; ?>
                                 </div>
                             <?php
                         }
                     }
                     else
                     {
                         echo "No platform Found";
                     }
                 ?>
             </div>

              <div class="shop-filter-body">
                 <h6>Genre List</h6>
                 <hr>
                 <?php
                    //Die Filter Liste anzeigen und Genre möglichkeiten zum Filtern Darstellen
                     $con = mysqli_connect("localhost","root","","ludomo");

                     $genre_query = "SELECT * FROM genre_list";
                     $genre_query_run  = mysqli_query($con, $genre_query);

                     if(mysqli_num_rows($genre_query_run) > 0)
                     {
                         foreach($genre_query_run as $genrelist)
                         {
                             $checked = [];
                             if(isset($_GET['genre']))
                             {
                                 $checked = $_GET['genre'];
                             }
                             ?>
                                 <div>
                                     <input type="checkbox" name="genre[]" value="<?= $genrelist['id']; ?>"
                                         <?php if(in_array($genrelist['id'], $checked)){ echo "checked"; } ?>
                                      />
                                      <?= $genrelist['genre']; ?>
                                 </div>
                             <?php
                         }
                     }
                     else
                     {
                         echo "No Genre Found";
                     }
                 ?>
               </div>

                <div class="shop-filter-body">
                   <h6>Brands List</h6>
                   <hr>
                   <?php
                      //Die Filter Liste anzeigen und Brands möglichkeiten zum Filtern Darstellen
                       $con = mysqli_connect("localhost","root","","ludomo");

                       $brand_query = "SELECT * FROM brands_list";
                       $brand_query_run  = mysqli_query($con, $brand_query);

                       if(mysqli_num_rows($brand_query_run) > 0)
                       {
                           foreach($brand_query_run as $brandlist)
                           {
                               $checked = [];
                               if(isset($_GET['brand']))
                               {
                                   $checked = $_GET['brand'];
                               }
                               ?>
                                   <div>
                                       <input type="checkbox" name="brand[]" value="<?= $brandlist['id']; ?>"
                                           <?php if(in_array($brandlist['id'], $checked)){ echo "checked"; } ?>
                                        />
                                        <?= $brandlist['brand']; ?>
                                   </div>
                               <?php
                           }
                       }
                       else
                       {
                           echo "No Brands Found";
                       }
                   ?>
               </div>

               <div class="shop-filter-body">
                  <h6>Prices List</h6>
                  <hr>
                  <?php
                    //Die Filter Liste anzeigen und Preis möglichkeiten zum Filtern Darstellen
                      $con = mysqli_connect("localhost","root","","ludomo");

                      $preise_query = "SELECT * FROM preise_list";
                      $preise_query_run  = mysqli_query($con, $preise_query);

                      if(mysqli_num_rows($preise_query_run) > 0)
                      {
                          foreach($preise_query_run as $preiselist)
                          {
                              $checked = [];
                              if(isset($_GET['preise']))
                              {
                                  $checked = $_GET['preise'];
                              }
                              ?>
                                  <div>
                                      <input type="checkbox" name="preise[]" value="<?= $preiselist['id']; ?>"
                                          <?php if(in_array($preiselist['id'], $checked)){ echo "checked"; } ?>
                                       />
                                        less than <?= $preiselist['preise']; ?> €
                                  </div>
                              <?php
                          }
                      }
                      else
                      {
                          echo "No Prices Found";
                      }
                  ?>
              </div>
               <div class="shop-filter-body">
                  <h6>FSK List</h6>
                  <hr>
                  <?php
                    //Die Filter Liste anzeigen und FSK möglichkeiten zum Filtern Darstellen
                      $con = mysqli_connect("localhost","root","","ludomo");

                      $fsk_query = "SELECT * FROM fsk_list";
                      $fsk_query_run  = mysqli_query($con, $fsk_query);

                      if(mysqli_num_rows($fsk_query_run) > 0)
                      {
                          foreach($fsk_query_run as $fsklist)
                          {
                              $checked = [];
                              if(isset($_GET['fsk']))
                              {
                                  $checked = $_GET['fsk'];
                              }
                              ?>
                                  <div>
                                      <input type="checkbox" name="fsk[]" value="<?= $fsklist['id']; ?>"
                                          <?php if(in_array($fsklist['id'], $checked)){ echo "checked"; } ?>
                                       />
                                      FSK <?= $fsklist['fsk']; ?>
                                  </div>
                              <?php
                          }
                      }
                      else
                      {
                          echo "No FSKs Found";
                      }
                  ?>
              </div>
          </div>
      </form>
  </div>

  <div class="shop-products">
    <?php
        $number_of_filter_checkboxes = 0;
        $products_items = array();
        $output_products = [];

        //Prüfe auf gesetzte Filter Optionen
        if(isset($_GET['brand']) || isset($_GET['fsk']) || isset($_GET['genre']) || isset($_GET['mode']) || isset($_GET['platform']) || isset($_GET['preise']) || isset($_GET['price']))
        {
            //Prise Sortierung
            if(isset($_GET['price'])){

              $number_of_filter_checkboxes++;
              $pricechecked = end($_GET['price']);

              //echo $row;
              $products = "SELECT * FROM `products`";

              if($pricechecked == 1){
                $products = "SELECT * FROM `products` ORDER BY endpreis";
              }

              if($pricechecked == 2){
                $products = "SELECT * FROM `products` ORDER BY endpreis DESC";
              }
              $products_run = mysqli_query($con, $products);
              if(mysqli_num_rows($products_run) > 0)
              {
                  foreach($products_run as $proditems) :
                      array_push($products_items, $proditems['name']);
                  endforeach;
              }

            }

            //Darstellung des Filter Möglichkeiten
            if(isset($_GET['brand'])){
              $number_of_filter_checkboxes++;
              $branchecked = [];
              $branchecked = $_GET['brand'];

              foreach($branchecked as $row)
              {
                  //echo $row;
                  $products = "SELECT products.* FROM products WHERE products.brand_id = ($row)";
                  $products_run = mysqli_query($con, $products);
                  if(mysqli_num_rows($products_run) > 0)
                  {
                      foreach($products_run as $proditems) :
                          array_push($products_items, $proditems['name']);
                      endforeach;
                  }
              }
            }
            //Darstellung des Filter Möglichkeiten
            if(isset($_GET['fsk'])){
              $number_of_filter_checkboxes++;
              $fskchecked = [];
              $fskchecked = $_GET['fsk'];

              foreach($fskchecked as $row)
              {
                  //echo $row;
                  $products = "SELECT * FROM products WHERE fsk_id IN ($row)";
                  $products_run = mysqli_query($con, $products);
                  if(mysqli_num_rows($products_run) > 0)
                  {
                      foreach($products_run as $proditems) :
                          array_push($products_items, $proditems['name']);
                      endforeach;
                  }
              }
            }
            //Darstellung des Filter Möglichkeiten
            if(isset($_GET['genre'])){
              $number_of_filter_checkboxes++;
              $genrechecked = [];
              $genrechecked = $_GET['genre'];

              foreach($genrechecked as $row)
              {
                  //echo $row;
                  $products = "SELECT * FROM products WHERE genre_id IN ($row)";
                  $products_run = mysqli_query($con, $products);
                  if(mysqli_num_rows($products_run) > 0)
                  {
                      foreach($products_run as $proditems) :
                          array_push($products_items, $proditems['name']);
                      endforeach;
                  }
              }
            }
            //Darstellung des Filter Möglichkeiten
            if(isset($_GET['mode'])){
              $number_of_filter_checkboxes++;
              $modechecked = [];
              $modechecked = $_GET['mode'];

              foreach($modechecked as $row)
              {
                  //echo $row;
                  $products = "SELECT * FROM products WHERE S_M_id IN ($row)";
                  $products_run = mysqli_query($con, $products);
                  if(mysqli_num_rows($products_run) > 0)
                  {
                      foreach($products_run as $proditems) :
                          array_push($products_items, $proditems['name']);
                      endforeach;
                  }
              }
            }
            //Darstellung des Filter Möglichkeiten
            if(isset($_GET['platform'])){
              $number_of_filter_checkboxes++;
              $platformchecked = [];
              $platformchecked = $_GET['platform'];

              foreach($platformchecked as $row)
              {
                  //echo $row;
                  $products = "SELECT products.* FROM products INNER JOIN platform ON platform.id = ($row) WHERE products.platform_id = platform.id";
                  $products_run = mysqli_query($con, $products);
                  if(mysqli_num_rows($products_run) > 0)
                  {
                      foreach($products_run as $proditems) :
                          array_push($products_items, $proditems['name']);
                      endforeach;
                  }
              }
            }
            //Darstellung des Filter Möglichkeiten
            if(isset($_GET['preise'])){
              $number_of_filter_checkboxes++;
              $preisechecked = [];
              $preisechecked = $_GET['preise'];

              foreach($preisechecked as $row)
              {
                  //echo $row;
                  $products = "SELECT products.* FROM products INNER JOIN preise_list ON preise_list.id = ($row) WHERE products.endpreis <= preise_list.preise";
                  $products_run = mysqli_query($con, $products);
                  if(mysqli_num_rows($products_run) > 0)
                  {
                      foreach($products_run as $proditems) :
                          array_push($products_items, $proditems['name']);
                      endforeach;
                  }
              }

            }


            //Produkte mit absicht Duplizieren und die gewollten Produkte (nach dem Filtern) anzuzeigen
            $unique_items = array_unique($products_items);
            $duplicated_items = [];

            $counter = 0;
            $counter_arr = [];

            foreach($unique_items as $current_united_item){
              foreach($products_items as $current_product_item){
                if($current_united_item == $current_product_item){
                  $counter++;
                }
              }
              if($counter == $number_of_filter_checkboxes){
                array_push($duplicated_items, $current_united_item);
              }
              $counter = 0;
            }
            //Filter zeigt nur duplizierte Produkte an (nach Filter gewünscht)
            foreach($duplicated_items as $current){
              $products = "SELECT products.* FROM products WHERE products.name = ('$current')";
              $products_run = mysqli_query($con, $products);
              if(mysqli_num_rows($products_run) > 0)
              {
                foreach($products_run as $proditems) :
                    ?>
    <div class="shop-product">
      <div class="shop-product-bage">
          <p>-<?= $proditems['rabatt']; ?>%</p>
      </div>
      <div class="shop-product-head">
        <form action="/dhbw/ludomo/php/product_overview.php">
          <button name="overview" value="<?= $proditems['ID']; ?>"><img src="<?= $proditems['picture']; ?>" alt="<?= $proditems['name']; ?>" /></button>
        </form>
        <p><?= $proditems['name']; ?></p>
      </div>
      <div class="shop-product-foot">
        <div class="shop-product-price">
          <p class="shop-price-ovp"><?= $proditems['preis']; ?>€</p>
          <p class="shop-price-end"><?= $proditems['endpreis']; ?>€</p>
        </div>
        <div class="shop-product-foot-btn">
          <form action="/dhbw/ludomo/php/warenkorb.php">
            <button name="add_to_cart" value="<?= $proditems['ID']; ?>" class="shop-add-btn">Add to cart</button>
          </form>
          <?php
              // Das Delete Button wird erst dann angezeigt, wenn man als Admin angemeldet ist. Nur dann kann man ein Produkt löschen
              if(isset($_COOKIE["username"]) && isset($_COOKIE["privalage"])){
                if($_COOKIE["privalage"] == 10){
                  ?>
                  <form action="/dhbw/ludomo/php/shop.php">
                    <button name="delete" value="<?= $proditems['ID']; ?>" class="shop-delete-btn">Remove</button>
                  </form>
                  <?php
                }
              }

          ?>

        </div>
      </div>
    </div>
        <?php
                endforeach;
              }
              else
              {
                    echo "No Items Found";
              }
            }
        }
        else
        {
          //Alle Produkte Anzeigen. Da kein Filter aktiviert ist
        $products = "SELECT * FROM products";
        //Prise Sortierung
        if(isset($_GET['price'])){

          $number_of_filter_checkboxes++;
          $pricechecked = end($_GET['price']);

          //Preis Aufsteigend oder Absteigend bestimmen
          if($pricechecked == 1){
            $products = "SELECT * FROM `products` ORDER BY endpreis";
          }

          if($pricechecked == 2){
            $products = "SELECT * FROM `products` ORDER BY endpreis DESC";
          }
        }

        $products_run = mysqli_query($con, $products);
        if(mysqli_num_rows($products_run) > 0)
        {
          foreach($products_run as $proditems) :
    ?>
    <div class="shop-product">
      <div class="shop-product-bage">
          <p>-<?= $proditems['rabatt']; ?>%</p>
      </div>
      <div class="shop-product-head">
        <form action="/dhbw/ludomo/php/product_overview.php">
          <button name="overview" value="<?= $proditems['ID']; ?>"><img src="<?= $proditems['picture']; ?>" alt="<?= $proditems['name']; ?>"/></button>
        </form>
        <p><?= $proditems['name']; ?></p>
      </div>
      <div class="shop-product-foot">
        <div class="shop-product-price">
          <p class="shop-price-ovp"><?= $proditems['preis']; ?>€</p>
          <p class="shop-price-end"><?= $proditems['endpreis']; ?>€</p>
        </div>
        <div class="shop-product-foot-btn">
          <form action="/dhbw/ludomo/php/warenkorb.php">
            <button name="add_to_cart" value="<?= $proditems['ID']; ?>" class="shop-add-btn">Add to cart</button>
          </form>

          <?php
            // Das Delete Button wird erst dann angezeigt, wenn man als Admin angemeldet ist. Nur dann kann man ein Produkt löschen
              if(isset($_COOKIE["username"]) && isset($_COOKIE["privalage"])){
                if($_COOKIE["privalage"] == 10){
                  ?>
                  <form action="/dhbw/ludomo/php/shop.php">
                    <button name="delete" value="<?= $proditems['ID']; ?>" class="shop-delete-btn">Remove</button>
                  </form>
                  <?php
                }
              }

          ?>

        </div>
      </div>
    </div>
      <?php
          endforeach;
        }
        else
        {
          echo "No Items Found";
        }
      }
      ?>
  </div>
</div>
<?php
// Das + Button wird erst dann angezeigt, wenn man als Admin angemeldet ist. Nur dann kann man ein Produkt anlegen
    if(isset($_COOKIE["username"]) && isset($_COOKIE["privalage"])){
      if($_COOKIE["privalage"] == 10){
        ?>
        <div class="shop-floating-btn"><a href="http://localhost/dhbw/ludomo/php/new_product.php">+</a></div>
        <?php
      }
    }

?>
